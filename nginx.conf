events {
    worker_connections 1024;
}

http {
    map $http_upgrade $connection_upgrade {
        default keep-alive;
        'websocket' Upgrade;
        '' close;
    }
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 启用错误拦截
    proxy_intercept_errors on;

    server {
        listen 80;
        server_name localhost;

        # 设置错误页面目录
        root /usr/share/nginx/html;

        # 错误页面配置
        error_page 500 502 503 504 /50x.html;
        error_page 404 /404.html;

        # 将 /webgate 代理到 Guacamole 服务
        location /webgate/ {
            # 移除 /webgate 前缀并代理到后端
            rewrite ^/webgate/(.*) /$1 break;
            proxy_pass http://host.docker.internal:8890;
            
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            
            # WebSocket 支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $http_connection;

            proxy_connect_timeout 4s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }

        # 50x 错误页面
        location = /50x.html {
            add_header Content-Type text/html;
            return 503 '<!DOCTYPE html>
<html>
<head>
    <title>Service Unavailable</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        h1 { color: #d9534f; }
        .container { max-width: 500px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>503 Service Unavailable</h1>
        <p>Guacamole service is temporarily unavailable.</p>
        <p>Please try again later.</p>
    </div>
</body>
</html>';
        }

        # 404 错误页面
        location = /404.html {
            add_header Content-Type text/html;
            return 404 '<!DOCTYPE html>
<html>
<head>
    <title>Page Not Found</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        h1 { color: #d9534f; }
        .container { max-width: 500px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>404 Not Found</h1>
        <p>The requested resource was not found.</p>
    </div>
</body>
</html>';
        }
    }
}